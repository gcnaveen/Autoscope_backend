service: car-inspection-api

provider:
  name: aws
  runtime: nodejs20.x
  region: ${opt:region, 'ap-south-1'}
  stage: ${opt:stage, 'dev'}
  timeout: 29
  memorySize: 512
  
  environment:
    NODE_ENV: ${self:provider.stage}
    STAGE: ${self:provider.stage}
    MONGODB_URI: ${env:MONGODB_URI, 'mongodb://localhost:27017/car_inspection_db'}
    JWT_SECRET: ${env:JWT_SECRET, 'your-super-secret-jwt-key-change-in-production'}
    JWT_EXPIRES_IN: ${env:JWT_EXPIRES_IN, '24h'}
    # S3 bucket for inspection images and videos (use env S3_BUCKET to override)
    S3_BUCKET: ${env:S3_BUCKET, 'autoscopedev'}
    # SMTP for emails (OTP, etc.)
    SMTP_HOST: ${env:SMTP_HOST, 'smtp.gmail.com'}
    SMTP_PORT: ${env:SMTP_PORT, '587'}
    SMTP_USER: ${env:SMTP_USER, ''}
    SMTP_PASSWORD: ${env:SMTP_PASSWORD, ''}
    # AWS_REGION is set automatically by Lambda â€“ do not set it here (reserved)

  httpApi:
    cors: true

  # S3: presigned URLs + multipart upload for large videos
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:PutObject
        - s3:PutObjectAcl
      Resource: arn:aws:s3:::autoscopedev/*
    - Effect: Allow
      Action:
        - s3:GetObject
      Resource: arn:aws:s3:::autoscopedev/*
    - Effect: Allow
      Action:
        - s3:CreateMultipartUpload
        - s3:UploadPart
        - s3:CompleteMultipartUpload
        - s3:AbortMultipartUpload
      Resource: arn:aws:s3:::autoscopedev/*
    - Effect: Allow
      Action:
        - s3:DeleteObject
      Resource: arn:aws:s3:::autoscopedev/*

functions:
  # Auth endpoints grouped into ONE lambda
  authApi:
    handler: src/handlers/authApi.handler
    events:
      - httpApi:
          path: /api/auth/register
          method: POST
      - httpApi:
          path: /api/auth/login
          method: POST
      - httpApi:
          path: /api/auth/send-otp
          method: POST
      - httpApi:
          path: /api/auth/verify-otp
          method: POST

  # User endpoints grouped into ONE lambda
  usersApi:
    handler: src/handlers/usersApi.handler
    events:
      - httpApi:
          path: /api/users
          method: GET
      - httpApi:
          path: /api/users
          method: POST
      - httpApi:
          path: /api/users/{id}
          method: GET
      - httpApi:
          path: /api/users/{id}
          method: PUT
      - httpApi:
          path: /api/users/{id}
          method: DELETE
      - httpApi:
          path: /api/users/{id}/block
          method: PUT
      - httpApi:
          path: /api/inspectors/available
          method: GET
      - httpApi:
          path: /api/inspectors/me/available-status
          method: PUT

  # Checklist + Upload (presigned S3) endpoints grouped into ONE lambda
  checklistApi:
    handler: src/handlers/checklistApi.handler
    events:
      # S3 upload: simple unrestricted image upload
      - httpApi:
          path: /api/upload/simple-image
          method: POST
      # S3 upload: presigned (photos/small video) + multipart (large video), folders by type
      - httpApi:
          path: /api/upload/presigned-url
          method: POST
      - httpApi:
          path: /api/upload/multipart/init
          method: POST
      - httpApi:
          path: /api/upload/multipart/part-urls
          method: POST
      - httpApi:
          path: /api/upload/multipart/complete
          method: POST
      - httpApi:
          path: /api/upload/multipart/abort
          method: POST
      - httpApi:
          path: /api/upload/delete
          method: POST
      # Template routes (admin)
      - httpApi:
          path: /api/checklists/templates
          method: POST
      - httpApi:
          path: /api/checklists/templates
          method: GET
      - httpApi:
          path: /api/checklists/templates/{id}
          method: GET
      - httpApi:
          path: /api/checklists/templates/{id}
          method: PUT
      - httpApi:
          path: /api/checklists/templates/{id}
          method: DELETE
      # Active templates (inspector)
      - httpApi:
          path: /api/checklists/templates/active
          method: GET
      # Inspection routes
      - httpApi:
          path: /api/checklists/inspections
          method: POST
      - httpApi:
          path: /api/checklists/inspections
          method: GET
      - httpApi:
          path: /api/checklists/inspections/{id}
          method: GET
      - httpApi:
          path: /api/checklists/inspections/{id}
          method: PUT
      - httpApi:
          path: /api/checklists/inspections/{id}
          method: DELETE
      - httpApi:
          path: /api/checklists/inspections/{id}/start
          method: POST

  # Admin Dashboard endpoint
  statisticsApi:
    handler: src/handlers/statisticsApi.handler
    events:
      - httpApi:
          path: /api/admin/dashboard
          method: GET

  # Make Management endpoints
  makeApi:
    handler: src/handlers/makeApi.handler
    events:
      - httpApi:
          path: /api/admin/makes
          method: POST
      - httpApi:
          path: /api/admin/makes
          method: GET
      - httpApi:
          path: /api/admin/makes/{id}
          method: GET
      - httpApi:
          path: /api/admin/makes/{id}
          method: PUT
      - httpApi:
          path: /api/admin/makes/{id}
          method: DELETE

  # Model Management endpoints
  modelApi:
    handler: src/handlers/modelApi.handler
    events:
      - httpApi:
          path: /api/admin/models
          method: POST
      - httpApi:
          path: /api/admin/models
          method: GET
      - httpApi:
          path: /api/admin/models/{id}
          method: GET
      - httpApi:
          path: /api/admin/models/{id}
          method: PUT
      - httpApi:
          path: /api/admin/models/{id}
          method: DELETE

  # Inspection Request endpoints grouped into ONE lambda
  inspectionRequestApi:
    handler: src/handlers/inspectionRequestApi.handler
    events:
      - httpApi:
          path: /api/inspection-requests
          method: POST
      - httpApi:
          path: /api/inspection-requests
          method: GET
      - httpApi:
          path: /api/inspection-requests/me
          method: GET
      - httpApi:
          path: /api/inspection-requests/inspector/assigned
          method: GET
      - httpApi:
          path: /api/inspection-requests/{id}
          method: GET
      - httpApi:
          path: /api/inspection-requests/{id}
          method: PUT
      - httpApi:
          path: /api/inspection-requests/{id}/assign
          method: PUT
      - httpApi:
          path: /api/inspection-requests/{id}/approve
          method: PUT
      - httpApi:
          path: /api/inspection-requests/{id}/reject
          method: PUT
      - httpApi:
          path: /api/inspection-requests/{id}/start
          method: POST
      - httpApi:
          path: /api/inspection-requests/admin/all
          method: GET

  # Contact Us
  contactApi:
    handler: src/handlers/contactApi.handler
    events:
      - httpApi:
          path: /api/contact
          method: POST
      - httpApi:
          path: /api/contact/admin
          method: GET

  # Swagger Documentation endpoints
  swaggerApi:
    handler: src/handlers/swaggerApi.handler
    events:
      - httpApi:
          path: /api/docs
          method: GET
      - httpApi:
          path: /api/docs/swagger.yaml
          method: GET
      - httpApi:
          path: /api/docs
          method: OPTIONS
      - httpApi:
          path: /api/docs/swagger.yaml
          method: OPTIONS

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

package:
  patterns:
    - '!node_modules/.cache/**'
    - '!*.md'
    - '!.git/**'
    - '!.env*'
    - '!tests/**'
    - 'swagger.yaml'
    - 'swagger.html'